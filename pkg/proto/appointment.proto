syntax = "proto3";

package proto;

import "google/protobuf/timestamp.proto";
import "referral.proto";
import "patient.proto";


option go_package = "pkg/proto/appointment";

message Appointment {
  uint32 id = 1;
  uint32 patient_id = 2;
  bool is_emergency = 3;
  uint32 procedure_id = 4;
  uint32 report_id = 5;
  uint32 referring_doctor_id = 6;
  uint32 reporting_doctor_id = 7;
  google.protobuf.Timestamp appointment_time = 8;
  uint32 organization_id = 9;
  uint32 payment_id = 10;
  string note = 11;
  string status = 12;
  repeated RequestForm request_form = 13;
  bool has_paid_commission = 14;
  google.protobuf.Timestamp created_at = 15;
  uint32 original_appointment_id = 16; 
  uint32 parent_appointment_id = 17;  
  int32 version = 18;                           
  bool is_active = 19;                          
  bool is_original = 20;                        
  uint32 modified_by = 22;            
  string modification_reason = 23;              
  google.protobuf.Timestamp modified_at = 24;
  bool is_locked = 25;
  string reason_for_locking = 26;
}

message ReportVersion {
    uint32 id = 1;
    uint32 report_id = 2;
    uint32 radiologist_id = 3;
    string findings = 4;
    string impressions = 5;
    string clinical_details = 6;
    string url = 7;
    string status = 8;
    string no_header_url = 9;
    google.protobuf.Timestamp confirmed_at = 10; 
}

message Report {
    uint32 id = 1;
    uint32 appointment_id = 2;
    string referring_hospital = 3;
    bool is_completed = 4;
    repeated ReportVersion versions = 5;
}

message RequestForm {
    uint32 id = 1;
    uint32 appointment_id = 2;
    string url = 3;
    bool is_file = 4;
}


message ModifyProcedure {
    Appointment old_version = 1;
    Appointment new_version = 2;
}

message ReportDeliveryStatus {
  uint32 report_id = 1;
  uint32 appointment_id = 2;
  string delivery_method = 3;
  string status = 4; // "sent", "failed"
  string message = 5;
  string recipient = 6;
  google.protobuf.Timestamp timestamp = 7;
}

message AppointmentRequest {
  uint32 id = 1;
}

message GetRecipientCountRequest {
    string recipient_type = 1; // "patient" or "referring_doctor"
    string target_type = 2; // "all", "filtered", "specific"
    FilterCriteria filter_criteria = 3;
    repeated uint32 specific_ids = 4;
}

message RecipientCountResponse {
    int32 total = 1;
    RecipientBreakdown breakdown = 2;
}

message RecipientBreakdown {
    int32 with_email = 1;
    int32 with_phone = 2;
    int32 with_push = 3;
}

message GetRecipientsRequest {
    string recipient_type = 1;
    string target_type = 2;
    FilterCriteria filter_criteria = 3;
    repeated uint32 specific_ids = 4;
    int32 offset = 5;
    int32 limit = 6;
}

message RecipientsResponse {
    repeated Recipient recipients = 1;
}

message Recipient {
    uint32 id = 1;
    string email = 2;
    string phone_number = 3;
    string device_id = 4;
    string first_name = 5;
    string last_name = 6;
    string recipient_type = 7;
}

message FilterCriteria {
    // Patient filters
    optional string gender = 1;
    optional int32 age_min = 2;
    optional int32 age_max = 3;
    optional string created_after = 4;        // ISO timestamp
    optional string created_before = 5;       // ISO timestamp
    reserved 6, 7;                            // Removed: last_appointment_from/to
    optional bool has_email = 8;
    optional bool has_phone_number = 9;
    optional bool allow_mobile_login = 10;
    
    // Referring Doctor filters
    repeated uint32 referring_center_ids = 11;
    optional string profession = 12;
    optional bool has_access_request = 13;
    optional bool is_disabled = 14;
    optional string last_login_after = 15;   // ISO timestamp
    
    // NEW: Patient targeting filters
    optional int32 birth_month = 16;          // 1-12 for birthday campaigns
    repeated uint32 organization_ids = 17;    // Multi-tenant filtering
    repeated uint32 modality_ids = 18;        // Target by scan type (MRI, CT, etc.)
    repeated uint32 procedure_ids = 19;       // Target by procedures performed
    
    // NEW: Referring Doctor engagement filters
    optional int32 days_since_last_referral = 20;  // Re-engage inactive doctors
    optional int32 min_referrals = 21;             // High-volume doctors (>= N)
    optional int32 max_referrals = 22;             // Low-volume doctors (<= N)
    
    // NEW: Referral trend analysis
    optional string referral_trend = 23;           // "increasing", "decreasing", "stable"
    optional int32 trend_period_days = 24;         // Compare last N days vs previous N (default: 30)
    optional double trend_threshold_pct = 25;      // Percentage change threshold (default: 20.0)
}


message GetPatientRequest {
  uint32 patient_id = 1;
}

message GetReferringDoctorRequest {
  uint32 doctor_id = 1;
}


service AppointmentService {
  rpc GetAppointment (AppointmentRequest) returns (Appointment) {}

  rpc GetRecipientCount(GetRecipientCountRequest) returns (RecipientCountResponse);
    
  rpc GetRecipients(GetRecipientsRequest) returns (RecipientsResponse);

  rpc GetPatient(GetPatientRequest) returns (Patient);
  rpc GetReferringDoctor(GetReferringDoctorRequest) returns (ReferringDoctor);
}